### **仿抖音客户端 Flutter 开发计划书**

**项目核心目标：** 高质量完成一个功能完整、体验流畅的仿抖音双列/单列视频流客户端。

**开发总览：** 本计划遵循“**先后端、后前端，先核心、后扩展，先功能、后优化**”的原则。我们将首先搭建好项目的基础架构和数据层，然后依次实现核心功能模块（外流 -> 内流 -> 评论），最后进行集中的性能优化和功能完善。

---

#### **第一阶段：项目奠基与数据层构建 (M1)**

**目标：** 搭建稳固的项目骨架，完成所有前期准备工作，为后续的 UI 开发铺平道路。

| 优先级 | 任务 | 关键实现点 | 产出物 |
| :--- | :--- | :--- | :--- |
| 1 | **项目初始化与环境配置** | `flutter create`，配置好分析选项 `analysis_options.yaml`。 | 一个可运行的空白 Flutter 项目。 |
| 2 | **搭建目录结构** | 严格按照文档第 4 节规划，创建 `features`, `common`, `router` 等目录。 | 标准化的项目目录结构。 |
| 3 | **添加并管理依赖** | 在 `pubspec.yaml` 中添加文档第 15 节列出的所有依赖。 | `pubspec.yaml` 和 `pubspec.lock` 文件。 |
| 4 | **定义核心数据模型** | 在 `common/models/` 下创建 `user.dart`, `video_post.dart`, `comment.dart`。 | 三个核心数据模型文件。 |
| 5 | **创建 Mock 数据** | 在 `assets/mock/` 目录下创建 `videos.json` 和 `comments_{id}.json` 等文件。 | 可供读取的 JSON 模拟数据。 |
| 6 | **实现数据仓库 (Repository)** | 创建 `MockApiClient` 读取并解析 JSON 数据，对外提供获取视频流、评论等数据的接口。 | `VideoRepository` 和 `CommentRepository` 等数据访问层。 |

---

#### **第二阶段：双列外流 (Feed) 核心功能实现 (M2)**

**目标：** 完成应用的主框架和双列信息流页面，实现从外流到内流的转场。

| 优先级 | 任务 | 关键实现点 | 产出物 |
| :--- | :--- | :--- | :--- |
| 1 | **实现应用主框架** | 使用 `BottomNavigationBar` 和 `TabBar` 搭建底部和顶部 Tab，其他 Tab 可暂时留空。 | 应用的整体导航框架。 |
| 2 | **配置路由** | 使用 `go_router` 配置 `/` (首页) 和 `/viewer/:id` (内流页) 的路由规则。 | `router/app_router.dart` 路由配置文件。 |
| 3 | **构建外流 UI** | 使用 `flutter_staggered_grid_view` 搭建双列瀑布流，完成卡片 UI 布局。 | `feed/views/feed_screen.dart` 页面。 |
| 4 | **连接数据与 UI** | 使用 `flutter_riverpod` 创建 `feedProvider`，从 Repository 获取数据并展示在 UI 上。 | 一个能显示视频封面的动态列表。 |
| 5 | **实现刷新与加载更多** | 集成 `pull_to_refresh` 或 `RefreshIndicator` 实现下拉刷新和上拉加载。 | 支持无限滚动的双列信息流。 |
| 6 | **实现封面转场动画** | 点击卡片时，使用 `Hero` 动画包裹封面图，并导航至内流页面。 | 从外流到内流的平滑过渡效果。 |

---

#### **第三阶段：单列内流 (Viewer) 视频播放实现 (M3)**

**目标：** 完成视频内流的核心功能，包括视频播放、手势交互和基础 UI。

| 优先级 | 任务 | 关键实现点 | 产出物 |
| :--- | :--- | :--- | :--- |
| 1 | **构建内流 UI 布局** | 搭建视频播放器、作者信息、转评赞按钮、音乐转盘等 UI 元素。 | `viewer/views/viewer_screen.dart` 页面。 |
| 2 | **集成视频播放器** | 使用 `video_player` 加载并播放视频，实现点击播放/暂停功能。 | 可播放视频的内流页面。 |
| 3 | **实现上下滑动切换** | 使用 `PageView.vertical` 实现上下滑动切换视频。 | 类似抖音的沉浸式视频浏览体验。 |
| 4 | **实现双击点赞动画** | 在手势检测层上添加双击事件，并播放一个心形缩放动画。 | 交互友好的点赞反馈。 |
| 5 | **实现音乐转盘动画** | 使用 `RotationTransition` 让音乐封面持续旋转。 | 动态的音乐转盘 UI。 |

---

#### **第四阶段：评论面板功能实现 (M4)**

**目标：** 完成评论的查看和发布功能，形成完整的用户交互闭环。

| 优先级 | 任务 | 关键实现点 | 产出物 |
| :--- | :--- | :--- | :--- |
| 1 | **构建评论面板 UI** | 使用 `showModalBottomSheet` 和 `DraggableScrollableSheet` 搭建可拖动的评论区。 | `comments/views/comments_panel.dart` 面板。 |
| 2 | **展示评论列表** | 创建 `commentsProvider`，根据视频 ID 从 Repository 获取并展示评论列表。 | 可滚动查看的评论列表。 |
| 3 | **实现发布新评论** | 在底部输入框输入内容，点击发送后，将新评论插入到列表顶部（内存操作）。 | 可发布新评论的交互功能。 |

---

#### **第五阶段：性能优化与体验打磨 (M5)**

**目标：** 集中解决性能瓶颈，提升应用的流畅度和稳定性，达到“丝滑”标准。

| 优先级 | 任务 | 关键实现点 | 产出物 |
| :--- | :--- | :--- | :--- |
| 1 | **实现视频预加载** | 在内流 `PageView` 中，提前初始化相邻页面的 `VideoPlayerController`。 | 切换视频时无明显黑屏或延迟。 |
| 2 | **实现播放器生命周期管理** | 结合 `visibility_detector`，实现离开屏幕自动暂停，进入屏幕自动播放。 | 优化的系统资源占用。 |
| 3 | **优化内存与 GPU** | 严格控制活跃的 `VideoPlayerController` 数量（≤3），及时 `dispose()` 释放资源。 | 稳定运行，避免内存泄漏。 |
| 4 | **实现图片缓存** | 确保 `cached_network_image` 正确配置，外流封面图实现磁盘和内存缓存。 | 快速加载的封面图片。 |
| 5 | **添加错误处理与空态页** | 为数据加载失败、列表为空等情况提供友好的提示和重试机制。 | 更健壮的应用。 |
| 6 | **最终测试与交付准备** | 进行全面的 Widget 和集成测试，录制演示视频，完善 `README.md`。 | 高质量的项目交付物。 |

---

#### **第六阶段：高级功能扩展 (可选, M6)**

**目标：** 在核心功能稳定且体验良好的前提下，根据项目时间和资源选择性实现。

| 优先级 | 任务 | 关键实现点 |
| :--- | :--- | :--- |
| 1 | **顶部 Tab 与外流左右联动** | 使用 `PageView` 结合 `TabController` 实现双向同步。 |
| 2 | **头像更换** | 使用 `image_picker` 和 `image_cropper` 实现选择、裁剪和保存。 |
| 3 | **AI 悬浮球** | 使用 `Stack` 和 `Draggable` 实现悬浮球，点击后打开聊天页面。 |