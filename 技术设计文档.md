# Flutter 仿抖音客户端技术设计文档（客户端，Mock 数据）

版本：v0.1（草案）  
作者：客户端训练营  
目标平台：Android / iOS  
框架：Flutter 3.x（Dart 3）

## 1. 项目目标与范围

- 目标：仿照抖音实现推荐双列页面（外流）与单列视频页面（内流），支持基本交互与评论面板。仅实现客户端，数据使用本地 Mock。
- 范围：实现“较容易 + 中等难度”功能点；“较难”项可挑选性实现（如顶部左右联动、头像更换、AI悬浮球）。
- 成果：代码仓库 + 技术设计文档（本文件）+ README + Demo 演示视频。

## 2. 技术选型

- UI 框架：Flutter（Material + 可定制主题）。
- 路由：`go_router`（简化 Navigator 2.0，支持声明式路由与转场）。
- 状态管理：`flutter_riverpod`（面向 MVVM 的 Provider 家族，低样板、可组合）。
- 视频播放：`video_player`（官方插件），可选 `chewie` 做包装控件。
- 列表瀑布流：`flutter_staggered_grid_view`（Masonry 双列动态高度）。
- 图片缓存：`cached_network_image`。
- 可见性检测：`visibility_detector`（自动暂停/播放）。
- 下拉刷新/上拉加载：`pull_to_refresh` 或内置 `RefreshIndicator` + 自定义加载文案。
- 评论面板：`showModalBottomSheet` + `DraggableScrollableSheet`（可拖拽底部面板）。
- 本地存储（可选）：`shared_preferences`（轻量配置）或 `sqflite`（离线缓存）。
- 动画与转场：`Hero` + `AnimatedSwitcher`/`FadeTransition`/`ScaleTransition`。

## 3. 架构设计（MVVM + Repository）

- 分层：
  - Model：`VideoPost`、`User`、`Comment` 等纯数据结构。
  - View：页面与组件（Feed 外流、Viewer 内流、Comments 面板等）。
  - ViewModel：页面状态（加载、分页、播放、点赞等），通过 Riverpod 提供。
  - Repository：数据访问层（Mock 数据读取、分页、提交评论）。
- 关键原则：
  - 视图只订阅状态，业务逻辑放入 ViewModel；
  - Repository 隔离数据源（未来可替换为服务端）；
  - 组件尽可能无状态（以参数和 Provider 驱动）。

## 4. 目录结构

```
lib/
  app.dart                # App 根部件与主题
  main.dart               # 入口
  router/                 # 路由定义（go_router）
  common/
    models/               # 数据模型
    widgets/              # 通用组件（头像、点赞按钮等）
    services/             # 工具服务（播放器管理、图片预加载等）
    repositories/         # 数据仓库（Mock 实现）
    theme/                # 主题与样式
    utils/                # 辅助函数
  features/
    feed/                 # 双列外流
      views/
      viewmodels/
      widgets/
    viewer/               # 单列视频内流
      views/
      viewmodels/
      widgets/
    comments/             # 评论面板
      views/
      viewmodels/
      widgets/
    tabs/                 # 顶部/底部 Tab
assets/
  mock/                   # 本地 Mock 数据（json / 图片 / 视频封面）
  images/
  videos/                 # 可选：短视频文件或转码片段（也可使用网络地址）
```

## 5. 主要页面与导航

- 路由结构（示例）：
  - `/` → 首页（顶部 Tab：推荐/关注/同城；底部 Nav：首页/朋友/消息/我）。
  - `/viewer/:id` → 视频内流详情（全屏 PageView 上下切换）。
  - `/comments/:id` → 评论面板（通常以 BottomSheet 展示，也可独立路由）。
- 导航策略：
  - 封面 `Hero(tag = post.id)` 转场至内流，避免短暂黑屏；
  - 内流使用 `PageView.vertical` 实现上下切换；
  - 顶部 `TabBar` + `PageView` 联动；底部 `BottomNavigationBar` 切换大模块。

## 6. 功能设计与实现思路

### 6.1 双列外流（Feed）

- UI：`MasonryGridView.count(crossAxisCount: 2)`；卡片包含封面图、昵称、点赞数、标题。
- 动态高度：卡片高度由文案长度与封面比例决定，使用 `flutter_staggered_grid_view` 自动布局。
- 进入内流：点击封面触发 `Hero` 转场；内流初始化后淡入视频画面（`AnimatedSwitcher`）。
- 刷新/分页：下拉刷新，尾部触底加载下一页；分页由 Repository 返回 `cursor/hasMore`。
- 顶部与底部 Tab：顶部类别切换、底部模块切换；双列页面左右滑动联动顶部 Tab（进阶）。

### 6.2 视频内流（Viewer）

- 播放器：`video_player`；播放/暂停点击控制，暂停时显示居中图标；可设置循环。
- 上下切换：`PageView.vertical`；离屏预加载相邻视频以降低切换卡顿。
- 双击点赞：在手势层添加心形动画（`ScaleTransition` + 短暂淡出）。
- 音乐转盘：右下角使用 `RotationTransition` 连续旋转；可点击进入音乐详情（占位）。
- 可见性：通过 `visibility_detector` 在列表或页面切换时自动暂停非可见视频。

### 6.3 评论面板（Comments）

- 入口：内流页面点击评论按钮弹出底部面板：`showModalBottomSheet(isScrollControlled: true)`。
- 布局：`DraggableScrollableSheet` + `ListView` 显示评论，顶部显示总数。
- 交互：输入框固定底部；发布新评论后插入列表顶部（Mock Repository 返回新对象）。
- 自适应：根据内容与键盘高度自动调整面板高度，支持拖动收起。

## 7. 数据模型（示例）

```dart
class User {
  final String id;
  final String nickname;
  final String avatarUrl;
  const User({required this.id, required this.nickname, required this.avatarUrl});
}

class VideoPost {
  final String id;
  final String coverUrl;
  final String videoUrl; // 可为本地或网络
  final String title;
  final int likeCount;
  final int commentCount;
  final User author;
  final String musicTitle;
  final String musicCoverUrl;
  final bool isLiked;
  final DateTime createdAt;
  const VideoPost({/* ... */});
}

class Comment {
  final String id;
  final String postId;
  final User author;
  final String content;
  final DateTime createdAt;
  const Comment({/* ... */});
}
```

## 8. Mock 数据与 Repository 设计

- 组织：`assets/mock/` 下维护 `videos.json`、`comments_{postId}.json`、用户列表等。
- 访问：`MockApiClient` 读取 JSON（`rootBundle.loadString`），解析为模型。
- 分页：在客户端生成 `pageSize/cursor`，或将 `videos.json` 分片存储；`hasMore` 由剩余条目判断。
- 评论提交：在内存集合中 `insert(0, newComment)` 并（可选）落盘本地缓存；返回最新集合。
- 可靠性：Mock 层可加入随机延迟与错误注入，用于验证错误处理与空态体验。

## 9. 状态管理与 Provider 设计（Riverpod）

- Providers：
  - `feedProvider`：当前顶部 Tab、分页状态、视频列表。
  - `viewerProvider(postId)`：单个视频播放状态（是否播放、缓冲进度、是否点赞）。
  - `commentsProvider(postId)`：评论列表与发布状态。
- ViewModel 方法：
  - Feed：`refresh()`、`loadMore()`、`switchTab()`。
  - Viewer：`play()`、`pause()`、`toggleLike()`、`onDoubleTap()`。
  - Comments：`sendComment(text)`、`refresh()`。

## 10. 动画与转场

- 封面转场：外流封面 → 内流全屏，通过 `Hero(tag = id)`；进入后 `FadeTransition` 从封面到视频画面。
- 点赞动画：双击显示心形图标，`ScaleTransition` 从小到大，`FadeOut` 消失。
- 音乐转盘：`RotationTransition` + `AlwaysStoppedAnimation` 或 `AnimationController.repeat()`。
- 刷新动效：自定义刷新头（Lottie 可选）与加载文字显示。

## 11. 顶部与底部 Tab

- 顶部：`TabBar + TabBarView`（推荐/关注/同城），左右滑动切换；进阶：与外流左右滑动联动。
- 底部：`BottomNavigationBar` 切换模块（首页/朋友/消息/我）。仅首页实现完整功能，其余可占位页。

## 12. 错误处理与空态

- 网络/Mock 读取失败：显示错误提示与重试按钮。
- 视频初始化失败：展示封面与提示，允许重试加载。
- 列表空态：友好的占位图与文案。

## 13. 性能优化

- 预加载：内流预加载前后相邻视频；外流预缓存封面图。
- 复用：列表项使用 `AutomaticKeepAliveClientMixin` 减少重复构建。
- 可见性：仅在可见区域播放视频，离屏自动暂停。
- 约束重绘：将点赞/评论等动效放入独立 Overlay，降低整页 Rebuild。

## 14. 主题与适配

- 主题：明暗模式支持；统一字号与间距系统（Spacing/FontScale）。
- 适配：常见机型与比例；竖屏为主，禁止横屏（内流可选支持）。

## 15. 依赖清单（候选）

```yaml
dependencies:
  flutter: ^3.24.0
  go_router: ^14.2.0
  flutter_riverpod: ^2.5.1
  video_player: ^2.9.2
  flutter_staggered_grid_view: ^0.7.0
  cached_network_image: ^3.4.1
  visibility_detector: ^0.4.0+2
  pull_to_refresh: ^2.0.0  # 或使用内置刷新
  # 可选：chewie, lottie, shared_preferences, sqflite, modal_bottom_sheet
```

## 16. 开发计划（里程碑）

- M1：项目初始化（路由/主题/依赖安装），Mock 数据结构与 Repository 搭建。
- M2：双列外流（UI、刷新、分页、转场），基础 Tab（顶部/底部）。
- M3：视频内流（播放/暂停、上下切换、双击点赞、音乐转盘）。
- M4：评论面板（布局、发送、顶部插入），优化可见性与预加载。
- M5：错误处理、空态、图片/视频缓存与性能优化，录制 Demo。
- M6（可选）：顶部左右联动、头像更换、AI 悬浮球（聊天页面对接开源框架）。

## 17. 测试策略

- Widget 测试：Feed 卡片渲染、分页加载按钮、Viewer 播放/暂停状态切换。
- 集成测试：路由跳转（外流 → 内流 → 评论面板）、发布评论后列表更新。
- 性能抽查：列表滚动流畅度、视频切换初始化时间。

## 18. 构建与发布

- 本地运行：`flutter pub get` → `flutter run`。
- 资源声明：将 `assets/mock/`、`assets/images/`、`assets/videos/` 写入 `pubspec.yaml`。
- 录制演示：使用 Android Studio/模拟器录屏或真机录屏，输出至仓库根目录 `Demo效果.mp4`。

## 19. 风险与对策

- 视频资源较大：优先使用网络短视频或本地小体积片段；内流预加载仅限相邻项。
- 动态高度与性能：使用 Masonry 布局并减少复杂阴影/渐变；必要时简化卡片装饰。
- iOS 权限：若使用本地视频/录屏功能需配置 Info.plist；当前仅播放无需权限。

## 20. 后续扩展

- 服务端替换：Repository 改造为 HttpClient；模型与接口保持一致以平滑迁移。
- AI 悬浮球：悬浮按钮拖动 + 聊天页面，调研开源 SDK（如 OpenAI API/本地 LLM）。
- 主题个性化：自定义主题切换与持久化。

---

### 对应“预期功能点”的映射说明

- 双列外流：卡片布局、点击封面进入内流、转场动画、动态高度、刷新加载、顶部/底部 bar；左右滑动联动顶部 bar（进阶）。
- 视频内流：布局、播放/暂停、上下切换、双击点赞、音乐转盘、刷新加载（可选）。
- 评论页面：UI 布局、自适应高度、发布新评论并置顶显示。
- AI 问答：悬浮球 + 聊天页面（可选，后续扩展）。

### 下一步落地建议

1) 初始化 Flutter 工程与依赖；2) 创建 `assets/mock/` 与模型；3) 先完成双列外流与路由，再迭代内流与评论面板。